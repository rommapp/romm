<script setup lang="ts">
import storeDownload from "@/stores/download";
import storeRoms, { type Rom } from "@/stores/roms";
import { languageToEmoji, regionToEmoji } from "@/utils";
import storeGalleryView from "@/stores/galleryView";
import { ref } from "vue";
import { useTheme } from "vuetify";
const theme = useTheme();

defineProps<{
  rom: Rom;
  isHoveringTop: boolean;
  showSelector: boolean;
  selected: boolean;
}>();
const downloadStore = storeDownload();
const romsStore = storeRoms();
const galleryViewStore = storeGalleryView();
const card = ref();
const emit = defineEmits(["selectRom"]);

let timeout: ReturnType<typeof setTimeout>;

// Functions
function onSelectRom(event: MouseEvent) {
  if (!event.ctrlKey && !event.shiftKey) {
    event.preventDefault();
    emit("selectRom", event);
  }
}

function onNavigate(event: MouseEvent) {
  if (
    event.ctrlKey ||
    event.shiftKey ||
    (romsStore.touchScreen && romsStore.selectedRoms.length > 0)
  ) {
    event.preventDefault();
    event.stopPropagation();
    emit("selectRom", event);
  }
}

function onTouchStart(event: TouchEvent) {
  card.value.$el.addEventListener("contextmenu", (event: Event) => {
    event.preventDefault();
  });
  romsStore.isTouchScreen(true);
  timeout = setTimeout(() => {
    emit("selectRom", event);
  }, 500);
}

function onTouchEnd() {
  clearTimeout(timeout);
}
</script>

<template>
  <router-link
    style="text-decoration: none; color: inherit"
    :to="
      romsStore.touchScreen && romsStore.selectedRoms.length > 0
        ? {}
        : {
            name: 'rom',
            params: { rom: rom.id },
          }
    "
    ref="card"
    @click="onNavigate"
    @touchstart="onTouchStart"
    @touchend="onTouchEnd"
  >
    <v-progress-linear
      color="romm-accent-1"
      :active="downloadStore.value.includes(rom.id)"
      :indeterminate="true"
      absolute
    />
    <v-hover v-slot="{ isHovering, props }" open-delay="800">
      <v-img
        :value="rom.id"
        :key="rom.id"
        v-bind="props"
        :src="
          !rom.igdb_id && !rom.has_cover
            ? `/assets/default/cover/big_${theme.global.name.value}_unmatched.png`
            : !rom.has_cover
            ? `/assets/default/cover/big_${theme.global.name.value}_missing_cover.png`
            : `/assets/romm/resources/${rom.path_cover_l}`
        "
        :lazy-src="
          !rom.igdb_id && !rom.has_cover
            ? `/assets/default/cover/small_${theme.global.name.value}_unmatched.png`
            : !rom.has_cover
            ? `/assets/default/cover/small_${theme.global.name.value}_missing_cover.png`
            : `/assets/romm/resources/${rom.path_cover_s}`
        "
        :aspect-ratio="3 / 4"
      >
        <template v-slot:placeholder>
          <div class="d-flex align-center justify-center fill-height">
            <v-progress-circular
              color="romm-accent-1"
              :width="2"
              indeterminate
            />
          </div>
        </template>
        <v-expand-transition>
          <div
            v-if="isHovering || !rom.has_cover"
            class="translucent text-caption"
          >
            <v-list-item>{{ rom.name || rom.file_name }}</v-list-item>
          </div>
        </v-expand-transition>
        <v-row no-gutters class="text-white px-1">
          <v-chip
            v-if="rom.regions.filter((i: string) => i).length > 0"
            :title="`Regions: ${rom.regions.join(', ')}`"
            class="translucent mr-1 mt-1"
            density="compact"
          >
            <span
              class="region-emoji"
              v-for="region in rom.regions.slice(
                0,
                galleryViewStore.current == 0 ? 2: 4
              )"
            >
              {{ regionToEmoji(region) }}
            </span>
          </v-chip>
          <v-chip
            v-if="rom.languages.filter((i: string) => i).length > 0"
            :title="`Languages: ${rom.languages.join(', ')}`"
            class="translucent mr-1 mt-1"
            density="compact"
          >
            <span
              class="language-emoji"
              v-for="language in rom.languages.slice(
                0,
                galleryViewStore.current == 0 ? 2 :4
              )"
            >
              {{ languageToEmoji(language) }}
            </span>
          </v-chip>
          <v-chip
            v-if="rom.siblings && rom.siblings.length > 0"
            :title="`${rom.siblings.length + 1} versions`"
            class="translucent mr-1 mt-1"
            density="compact"
          >
            +{{ rom.siblings.length }}
          </v-chip>
        </v-row>
        <v-icon
          v-show="isHoveringTop && showSelector"
          @click="onSelectRom"
          size="small"
          class="position-absolute checkbox"
          :class="{ 'checkbox-selected': selected }"
          >{{ selected ? "mdi-circle-slice-8" : "mdi-circle-outline" }}</v-icon
        >
      </v-img>
    </v-hover>
  </router-link>
</template>

<style scoped>
.checkbox {
  bottom: 0.2rem;
  right: 0.2rem;
}
.translucent {
  background: rgba(0, 0, 0, 0.35);
  backdrop-filter: blur(10px);
  text-shadow: 1px 1px 1px #000000, 0 0 1px #000000;
}

.region-emoji,
.language-emoji {
  margin: 0 2px;
}
</style>
